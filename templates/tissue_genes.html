<html>
    <meta>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
    </meta>
  <head>
    <title>Tissue Top/Bottom Genes (Z-scored)</title>
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 1400px;
                margin: 20px auto;
                padding: 20px;
                background-color: #f5f5f5;
            }
            h1 {
                color: #333;
                border-bottom: 3px solid #2196F3;
                padding-bottom: 10px;
            }
            select {
                font-family: Arial, sans-serif;
            }

            .back-button {
                display: inline-block;
                background-color: #4CAF50;
                color: white;
                padding: 12px 30px;
                text-decoration: none;
                border-radius: 5px;
                margin-top: 20px;
                transition: background-color 0.3s;
            }
            .back-button:hover {
                background-color: #45a049;
            }

        </style>
    </style>
  </head>
  <body>
    <h1>Tissue Top and Bottom Expressed Genes (Z-scored vs other tissues)</h1>

    <div class="controls">
      <label for="tissueSelect"><strong>Tissue:</strong></label>
      <select id="tissueSelect">
        {% for t in tissues %}
          <option value="{{ t }}">{{ t }}</option>
        {% endfor %}
      </select>

      <label for="topN"><strong>Top N:</strong></label>
      <input id="topN" type="number" value="20" min="1" max="200" style="width:80px">

      <button id="refreshBtn">Refresh</button>
      <div style="position: relative; left:50px; display: inline;">
         <a href="/" class="back-button">‚Üê Back to Home</a>
      </div> 
     
    </div>
    
    <div id="plot" style="width:1000px; height:700px;"></div>

    <script>
      const tissueSelect = document.getElementById('tissueSelect');
      const topNInput = document.getElementById('topN');
      const refreshBtn = document.getElementById('refreshBtn');
      const plotDiv = document.getElementById('plot');

      async function fetchAndPlot() {
        const tissue = tissueSelect.value;
        const topN = parseInt(topNInput.value) || 20;

        try {
          const resp = await fetch(`/api/tissue_top_genes?tissue=${encodeURIComponent(tissue)}&top=${topN}`);
          const data = await resp.json();
          if (resp.status !== 200) {
            plotDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            return;
          }

          // Combine bottom (negative) and top (positive) lists for plotting
          const bottom = data.bottom || [];
          const top = data.top || [];

          // Merge lists, dedupe genes (keep the entry with larger absolute z if duplicated)
          const merged = bottom.concat(top);
          const byGene = {};
          merged.forEach(item => {
            const g = item.gene;
            if (!(g in byGene)) {
              byGene[g] = item;
            } else {
              // keep the one with larger absolute z-score
              if (Math.abs(item.z) > Math.abs(byGene[g].z)) {
                byGene[g] = item;
              }
            }
          });

          // Create array and sort so highest positive z are first, negatives last
          const combined = Object.values(byGene).sort((a, b) => b.z - a.z);

          const genes = combined.map(d => d.gene);
          const zs = combined.map(d => d.z);
          const colors = zs.map(z => z >= 0 ? '#1f77b4' : '#ff7f0e');

          const trace = {
            x: zs,
            y: genes,
            type: 'bar',
            orientation: 'h',
            marker: { color: colors },
            hovertemplate: '%{y}<br>z: %{x:.2f}<extra></extra>'
          };

          const layout = {
            title: `Top/Bottom ${topN} genes for tissue: ${tissue}`,
            xaxis: { title: 'Z-score (vs other tissues)' },
            margin: { l: 300, r: 40, t: 80, b: 80 },
            height: Math.max(400, genes.length * 24 + 150)
          };

          Plotly.newPlot(plotDiv, [trace], layout, {responsive:true});
        } catch (err) {
          plotDiv.innerHTML = `<pre>Error: ${err.message}</pre>`;
          console.error(err);
        }
      }

      // initial plot
      fetchAndPlot();

      refreshBtn.addEventListener('click', fetchAndPlot);
      tissueSelect.addEventListener('change', fetchAndPlot);
      topNInput.addEventListener('change', fetchAndPlot);
    </script>
  </body>
</html>
